<#
.SYNOPSIS
   Einzelne Schritte um von CVE-2023-23397 betroffene Mails im Exchange Online zu finden
 
.DESCRIPTION
   Die Befehle in diesem Skript sind einzeln auszuführen, um den jeweils 
   gewünschten Effekt zu erzielen.
   Die Scripts sind zur Ausführung des von Microsoft bereitgestellten Scripts https://microsoft.github.io/CSS-Exchange/Security/CVE-2023-23397/
      
 .NOTES
  Version:        
  Author:         Thomas Thaler
  Creation Date:  2023-03-15
  Purpose/Change: Initial Creation
#>

#Module Installieren
Install-Module AzureAD -Scope CurrentUser
Install-Module ExchangeOnlineManagement -Scope CurrentUser
# Module Importieren
Import-Module AzureAD
Import-Module ExchangeOnlineManagement

# Azure App Registrieren
.\CVE-2023-23397.ps1 -CreateAzureApplication

#Mit Exchange Online verbinden
Connect-ExchangeOnline

# Alle Postfächer Scannen
Get-Mailbox | .\CVE-2023-23397.ps1 -Environment "Online" -StartTimeFilter "01/01/2022 00:00:00" -EndTimeFilter "01/01/2024 00:00:00" 
# Falls der Befehl davor fehlschlägt
Get-Mailbox | .\CVE-2023-23397.ps1 -Environment "Online" -StartTimeFilter "01/01/2022 00:00:00" -EndTimeFilter "01/01/2024 00:00:00" -dllpath .\exchange.webservices.managed.api.2.2.1.2\lib\net35\Microsoft.Exchange.WebServices.dll

# Optional: einzelnes Postfach Scannen
Get-Mailbox <emailadresse> | .\CVE-2023-23397.ps1 -Environment "Online" -StartTimeFilter "01/01/2022 00:00:00" -EndTimeFilter "01/01/2024 00:00:00"

# Cleanup Starten
.\CVE-2023-23397.ps1 -CleanupAction ClearProperty -CleanupInfoFilePath <Path to modified CSV>
.\CVE-2023-23397.ps1 -CleanupAction ClearItem -CleanupInfoFilePath <Path to modified CSV>

# Azure App Löschen
.\CVE-2023-23397.ps1 -DeleteAzureApplication
